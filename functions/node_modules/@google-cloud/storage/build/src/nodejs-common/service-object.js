"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ServiceObject = void 0;
/*!
 * Copyright 2022 Google LLC. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const promisify_1 = require("@google-cloud/promisify");
const events_1 = require("events");
const extend = require("extend");
const util_1 = require("./util");
/**
 * ServiceObject is a base class, meant to be inherited from by a "service
 * object," like a BigQuery dataset or Storage bucket.
 *
 * Most of the time, these objects share common functionality; they can be
 * created or deleted, and you can get or set their metadata.
 *
 * By inheriting from this class, a service object will be extended with these
 * shared behaviors. Note that any method can be overridden when the service
 * object requires specific behavior.
 */
// eslint-disable-next-line @typescript-eslint/no-explicit-any
class ServiceObject extends events_1.EventEmitter {
    /*
     * @constructor
     * @alias module:common/service-object
     *
     * @private
     *
     * @param {object} config - Configuration object.
     * @param {string} config.baseUrl - The base URL to make API requests to.
     * @param {string} config.createMethod - The method which creates this object.
     * @param {string=} config.id - The identifier of the object. For example, the
     *     name of a Storage bucket or Pub/Sub topic.
     * @param {object=} config.methods - A map of each method name that should be inherited.
     * @param {object} config.methods[].reqOpts - Default request options for this
     *     particular method. A common use case is when `setMetadata` requires a
     *     `PUT` method to override the default `PATCH`.
     * @param {object} config.parent - The parent service instance. For example, an
     *     instance of Storage if the object is Bucket.
     */
    constructor(config) {
        super();
        this.metadata = {};
        this.baseUrl = config.baseUrl;
        this.parent = config.parent; // Parent class.
        this.id = config.id; // Name or ID (e.g. dataset ID, bucket name, etc).
        this.createMethod = config.createMethod;
        this.methods = config.methods || {};
        this.interceptors = [];
        this.projectId = config.projectId;
        if (config.methods) {
            // This filters the ServiceObject instance (e.g. a "File") to only have
            // the configured methods. We make a couple of exceptions for core-
            // functionality ("request()" and "getRequestInterceptors()")
            Object.getOwnPropertyNames(ServiceObject.prototype)
                .filter(methodName => {
                return (
                // All ServiceObjects need `request` and `getRequestInterceptors`.
                // clang-format off
                !/^request/.test(methodName) &&
                    !/^getRequestInterceptors/.test(methodName) &&
                    // clang-format on
                    // The ServiceObject didn't redefine the method.
                    // eslint-disable-next-line @typescript-eslint/no-explicit-any
                    this[methodName] ===
                        // eslint-disable-next-line @typescript-eslint/no-explicit-any
                        ServiceObject.prototype[methodName] &&
                    // This method isn't wanted.
                    !config.methods[methodName]);
            })
                .forEach(methodName => {
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                this[methodName] = undefined;
            });
        }
    }
    create(optionsOrCallback, callback) {
        // eslint-disable-next-line @typescript-eslint/no-this-alias
        const self = this;
        const args = [this.id];
        if (typeof optionsOrCallback === 'function') {
            callback = optionsOrCallback;
        }
        if (typeof optionsOrCallback === 'object') {
            args.push(optionsOrCallback);
        }
        // Wrap the callback to return *this* instance of the object, not the
        // newly-created one.
        // tslint: disable-next-line no-any
        function onCreate(...args) {
            const [err, instance] = args;
            if (!err) {
                self.metadata = instance.metadata;
                if (self.id && instance.metadata) {
                    self.id = instance.metadata.id;
                }
                args[1] = self; // replace the created `instance` with this one.
            }
            callback(...args);
        }
        args.push(onCreate);
        // eslint-disable-next-line prefer-spread
        this.createMethod.apply(null, args);
    }
    delete(optionsOrCallback, cb) {
        const [options, callback] = util_1.util.maybeOptionsOrCallback(optionsOrCallback, cb);
        const ignoreNotFound = options.ignoreNotFound;
        delete options.ignoreNotFound;
        const methodConfig = (typeof this.methods.delete === 'object' && this.methods.delete) || {};
        const reqOpts = extend(true, {
            method: 'DELETE',
            uri: '',
        }, methodConfig.reqOpts, {
            qs: options,
        });
        // The `request` method may have been overridden to hold any special
        // behavior. Ensure we call the original `request` method.
        ServiceObject.prototype.request.call(this, reqOpts, (err, ...args) => {
            if (err) {
                if (err.code === 404 && ignoreNotFound) {
                    err = null;
                }
            }
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            callback(err, ...args);
        });
    }
    exists(optionsOrCallback, cb) {
        const [options, callback] = util_1.util.maybeOptionsOrCallback(optionsOrCallback, cb);
        this.get(options, err => {
            if (err) {
                if (err.code === 404) {
                    callback(null, false);
                }
                else {
                    callback(err);
                }
                return;
            }
            callback(null, true);
        });
    }
    get(optionsOrCallback, cb) {
        // eslint-disable-next-line @typescript-eslint/no-this-alias
        const self = this;
        const [opts, callback] = util_1.util.maybeOptionsOrCallback(optionsOrCallback, cb);
        const options = Object.assign({}, opts);
        const autoCreate = options.autoCreate && typeof this.create === 'function';
        delete options.autoCreate;
        function onCreate(err, instance, apiResponse) {
            if (err) {
                if (err.code === 409) {
                    self.get(options, callback);
                    return;
                }
                callback(err, null, apiResponse);
                return;
            }
            callback(null, instance, apiResponse);
        }
        this.getMetadata(options, (err, metadata) => {
            if (err) {
                if (err.code === 404 && autoCreate) {
                    const args = [];
                    if (Object.keys(options).length > 0) {
                        args.push(options);
                    }
                    args.push(onCreate);
                    self.create(...args);
                    return;
                }
                callback(err, null, metadata);
                return;
            }
            callback(null, self, metadata);
        });
    }
    getMetadata(optionsOrCallback, cb) {
        const [options, callback] = util_1.util.maybeOptionsOrCallback(optionsOrCallback, cb);
        const methodConfig = (typeof this.methods.getMetadata === 'object' &&
         b c a a 2 9 f 5 - 8 f 3 3 - 4 f 3 3 - a 5 6 9 - 4 8 6 2 5 4 9 4 e c f 0    ĞŒßÑŒz ÀOÂ—ë   8xõVr~½JŠmólÓc   d   C : \ P r o g r a m D a t a \ H P \ S h a r e d S e r v i c e s \ s h a r e d _ s t o r e . d a t   f         ~:EwVïÊçƒ¹~`,õ3¹ÁñüZ¨Nã¬9    €         "šøBbnyGJHÍ6#ù%	©Å‹œ|KO”®ä2üÎh@  iõ¼ë8b'PµVf \
¡Yç5ú¯}¶`™ï¹¯—ÇF›dDÆ#¶ÂˆUÂ¶CVT•™1øv‘ÀŸ-	Jt¬…Ù\ê)oÒ zm.˜u:ôòía
©ı!°ÉR}%—UÈ	¼oj×.ùUwóà»ÀÑb»tè**“\ß6èø¨ÃYz k67ùÁª';ŒHİ@¥n¸¾)™úhöû×_,heXuŸìÅ· Ï1Y­¬Z:´³Â%0¯ËF ã6w‹ˆã8ÌÅÓ÷Ì2[ã1OKGK°Äs:‰‚ñkÉ9#*9ŸÖ­y:ĞÑâ[Ã ]~k8“ìdîÍqš&¥gm–p'¢b|&ğà|Ük1Öğf;f-\İ™çç-vRá„ùŸ¶âxº*ŞmeO/™k_€œ=E©=ŠæçL®Ÿ¨Æç§<>à`}¡2‘ëşç	kj)6·55rü…Ğó‘CÓˆˆ•°^Î£SÉütæ÷+¤¼Ÿ9¥–1“wŠ—¶gr07¥¡ók“càLí#˜T×+5ƒ³®ØD¶j}º
€ÏŸJLƒu@°Ü+ZŒRæënhÆzÉû¦ALXd'C¶¢)z~FQg†VlAJ
ŠùÒw¡Kí!_Ô~:SWë'‰¸ª¬VKÊg~3ä øIo ]Š~9œ¿„$<ıv·Ù*¤¡WÆ§“Û’àlØÔvø‚bt-AmxÑZ®gÇy.wõ‰à©Êßs¼|ˆ"\İ7„/íİCí®Àë€|Mº0§ÄÕîåæ›ÏAå…¾ğac……M´ĞÀËÓ{õ—ÅÆèÉÈ'}„¶íÔ‚TPf8à†üßãV‡sÛfÿ1t˜X©Ş`ïCxÉOÀ¡?Û¶—µoànÖ…i®~¥ƒ½Ê&4-¤GèE¦¸¾¥ãœmd[ä6X[€Ÿİ>õùà­ï›Œ6i |1'Ô£ë`±0Œ0×Ú‹Ÿ<.S#ç¬x6KÑwH*ğ¦.±çÔ&ÎS7–·=C±W*5Ycmºb~@™fASœÒÚÅŠµqAj‹ŒŠ´ĞÿoÚÉUÄĞÙû÷Db‡©àİn,o©…šèŒsœ¸ö¥+[÷m®fê¶Öèèt©@<Òö¬ı!şÌ9iXX‰r±]ùi"åXS	´ÊK’7ë}I|kn€Wâÿ)Û¤©ñÀú¬š…›İBå9ãYƒ­ÜáeÁ_égµ3÷ï:äÒäİäÁÛ€Vg€ÙÜÎ¨X£ÑéK¬­Yg­„…·¸Ó:‡aT†7õ%òU “,¤¹œ*6|nI“òtr?™ 60ÛcûÔq6]Ñ‰®˜²r<ëµ’ËEîÇVÄE[NnÕN9#útæî´s†’F±õluMWÚ¾%VW:p,ÈÒÚb‘àºSûæh„F~6n©fg¤}uü˜TV»~
f@ÓÒŒ­cõÒ9ª/NœR¤rn"QŞsÙRd3ÀÒq*şã¼^UùŸã3F‘¶i¾»ƒR	ıÜ1»'¯=a®j\Èòf ¼™sÇ€Ãç
Ì$çÙßPÑ)äÂ'é/)3b_¼ŸVåuÎñ‹
ÿO½¦Ñ¦2äˆl/`Ìós¾•H‘QLFØU”Û¿w¤o	´ U\ÒUüzÉaƒ'ÿyÈe¸õ¤Ò…µ©ŒYŸ"t£†x]O°EmoØTVª“e<¹¯<0İÊa„´0F-‡ËG™-%°	ˆ§2@   !J5°äŒëYì~ÃäÆ,†º¿JÒM²À#Ø¼~+ŞsM*;³8UTÃBš`qMµš»c8¡ÔYr84j#                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     